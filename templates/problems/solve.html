{% extends 'base.html' %}

{% block title %}Solve: {{ problem.title }} - CodeMaster{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
<style>
    /* UPDATED: This now has 3 columns (problem, handle, code) */
    .solve-container {
        display: grid;
        grid-template-columns: 40% 8px 1fr;
        height: calc(100vh - 76px);
        overflow: hidden;
        border-top: 1px solid var(--light-border-color);
    }
    body.dark-mode .solve-container {
        border-top: 1px solid var(--dark-border-color);
    }

    .problem-panel, .code-panel {
        height: 100%;
        overflow-y: auto;
        padding: 25px;
        box-sizing: border-box;
    }
    .problem-panel {
        background-color: var(--light-background);
        border-right: 1px solid var(--light-border-color);
    }
    body.dark-mode .problem-panel {
        background-color: var(--dark-background);
        border-right: 1px solid var(--dark-border-color);
    }
    
    /* UPDATED: Removed the fixed 'width' property */
    .code-panel {
        display: flex;
        flex-direction: column;
        background-color: var(--light-card-background);
    }
    body.dark-mode .code-panel {
        background-color: var(--dark-card-background);
    }

    .CodeMirror {
        flex-grow: 1;
        height: auto;
        border: 1px solid var(--light-border-color);
        border-radius: 0.75rem;
        font-size: 0.95rem;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    body.dark-mode .CodeMirror {
        border: 1px solid var(--dark-border-color);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }

    .resize-handle {
        width: 8px;
        cursor: col-resize;
        background-color: var(--light-border-color);
        transition: background-color 0.3s ease;
    }
    body.dark-mode .resize-handle {
        background-color: var(--dark-border-color);
    }
    .resize-handle:hover {
        background-color: var(--primary-color);
    }

    .problem-description {
        line-height: 1.8;
        font-size: 1.05rem;
        color: var(--light-text);
    }
    body.dark-mode .problem-description {
        color: #ffffff;
    }

    .sample-test-cases pre, .test-cases-container pre {
        background-color: #2d3748;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
        border: 1px solid rgba(255,255,255,0.1);
    }

    #customInput {
        border-radius: 0.75rem;
        border: 1px solid var(--light-border-color);
        background-color: var(--light-background);
        color: var(--light-text);
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    body.dark-mode #customInput {
        border: 1px solid var(--dark-border-color);
        background-color: var(--dark-background);
        color: var(--dark-text);
    }
    #customInput:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
    }

    .form-select {
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        border: 1px solid var(--light-border-color);
        background-color: var(--light-card-background);
        color: var(--light-text);
    }
    body.dark-mode .form-select {
        background-color: var(--dark-card-background);
        color: var(--dark-text);
        border-color: var(--dark-border-color);
    }
    
    .badge {
        padding: 0.5em 0.8em;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.85em;
        text-transform: uppercase;
    }

    .badge.bg-easy {
        background-color: #28a745 !important;
        color: white;
    }
    .badge.bg-medium {
        background-color: #ffc107 !important;
        color: #343a40;
    }
    .badge.bg-hard {
        background-color: #dc3545 !important;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="solve-container">

    <div class="problem-panel">
        <h2>{{ problem.title }}</h2>
        <p><span class="badge bg-{{ problem.difficulty|lower }}">{{ problem.difficulty }}</span></p>
        <hr>

        <div class="problem-description">
            {{ problem.description|safe }}
        </div>

        <div class="sample-test-cases mt-4">
            <h4>Sample Test Cases</h4>
            {% for test_case in problem.testcase_set.all %}
                {% if test_case.is_sample %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Test Case {{ forloop.counter }}</h6>
                            <strong>Input:</strong>
                            <pre><code>{{ test_case.input_data }}</code></pre>
                            <strong>Output:</strong>
                            <pre><code>{{ test_case.expected_output }}</code></pre>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        {% if problem.constraints %}
        <div class="constraints mt-4">
            <h4>Constraints</h4>
            <div class="problem-description">
                {{ problem.constraints|linebreaks }}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="resize-handle" id="resizeHandle"></div>

    <div class="code-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <select id="languageSelector" class="form-select w-auto">
                <option value="python">Python</option>
                <option value="cpp">C++</option>
                <option value="java">Java</option>
                <option value="c">C</option>
            </select>
            <div>
                <button id="runBtn" class="btn btn-secondary me-2"><i class="fas fa-play"></i> Run</button>
                <button id="submitBtn" class="btn btn-primary">Submit Solution</button>
            </div>
        </div>

        <h4>Your Code</h4>
        <textarea id="codeEditor"></textarea>
        

        <div class="test-cases-container mt-3">
            <ul class="nav nav-tabs" id="testCaseTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="sample-tests-tab" data-bs-toggle="tab" data-bs-target="#sample-tests" type="button" role="tab" aria-controls="sample-tests" aria-selected="true">Sample Tests</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="custom-test-tab" data-bs-toggle="tab" data-bs-target="#custom-test" type="button" role="tab" aria-controls="custom-test" aria-selected="false">Custom Input</button>
                </li>
            </ul>

            <div class="tab-content pt-2" id="testCaseTabsContent">
                <div class="tab-pane fade show active" id="sample-tests" role="tabpanel" aria-labelledby="sample-tests-tab">
                    <div id="sampleTestResults">
                        <div class="alert alert-info">Click "Run" to see results for sample test cases here.</div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="custom-test" role="tabpanel" aria-labelledby="custom-test-tab">
                    <div class="mt-3 custom-test-section">
                        <textarea id="customInput" class="form-control" rows="3" placeholder="Enter custom input here..."></textarea>
                        <button id="runCustomTestBtn" class="btn btn-secondary mt-2"><i class="fas fa-play"></i> Run Custom Test</button>
                        <div id="customTestResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ code_templates_json|json_script:"code-templates-json" }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
            lineNumbers: true,
            mode: 'python',
            theme: 'material-darker',
            autoCloseBrackets: true,
            matchBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
        });

        const languageSelector = document.getElementById('languageSelector');
        const problemId = "{{ problem.id }}";
        const acceptedCode = {% if accepted_code %}`{{ accepted_code|escapejs }}`{% else %}null{% endif %};
        const acceptedLanguage = "{{ accepted_language|default:'' }}";
        const defaultTemplates = JSON.parse(document.getElementById('code-templates-json').textContent);

        function getLocalStorageKey(language) {
            return `code-${problemId}-${language}`;
        }

        function saveCode() {
            const code = editor.getValue();
            const language = languageSelector.value;
            localStorage.setItem(getLocalStorageKey(language), code);
        }

        function loadCodeForLanguage(language) {
            let codeToLoad = '';
            if (acceptedLanguage === language && acceptedCode) {
                codeToLoad = acceptedCode;
            } else {
                const savedCode = localStorage.getItem(getLocalStorageKey(language));
                codeToLoad = savedCode || defaultTemplates[language] || '';
            }
            editor.setValue(codeToLoad);
        }

        languageSelector.addEventListener('change', function() {
            const language = this.value;
            let mode = 'python';
            if (language === 'cpp') mode = 'text/x-c++src';
            else if (language === 'java') mode = 'text/x-java';
            else if (language === 'c') mode = 'text/x-csrc';
            
            editor.setOption("mode", mode);
            loadCodeForLanguage(language);
        });

        editor.on('change', saveCode);

        // Initial load
        if (acceptedLanguage) {
            languageSelector.value = acceptedLanguage;
        }
        languageSelector.dispatchEvent(new Event('change'));

        // Resizing logic
        const resizeHandle = document.getElementById('resizeHandle');
        const problemPanel = document.querySelector('.problem-panel');
        const solveContainer = document.querySelector('.solve-container');

        resizeHandle.addEventListener('mousedown', function(e) {
            e.preventDefault();
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', () => {
                document.removeEventListener('mousemove', handleMouseMove);
            });
        });

        function handleMouseMove(e) {
            const containerRect = solveContainer.getBoundingClientRect();
            const newProblemPanelWidth = e.clientX - containerRect.left;
            const percentageWidth = (newProblemPanelWidth / containerRect.width) * 100;

            if (percentageWidth > 20 && percentageWidth < 80) { // Set min/max resize limits
                solveContainer.style.gridTemplateColumns = `${percentageWidth}% 8px 1fr`;
            }
        }
        
        
        
        // Generic function to run code via API
        async function runCode(code, language, input) {
            const response = await fetch("{% url 'submissions_api:run-code' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ problem_id: problemId, code, language, input: input })
            });
            return await response.json();
        }
        
        // Custom Test Run button
        const runCustomTestBtn = document.getElementById('runCustomTestBtn');
        const customTestResult = document.getElementById('customTestResult');
        runCustomTestBtn.addEventListener('click', async function() {
            const code = editor.getValue();
            const language = languageSelector.value;
            const customInput = document.getElementById('customInput').value;
            
            customTestResult.innerHTML = '<div class="alert alert-info">Running...</div>';
            const data = await runCode(code, language, customInput);

            if (data.success) {
                customTestResult.innerHTML = `<div class="alert alert-success"><strong>Output:</strong><pre>${data.output}</pre></div>`;
            } else {
                customTestResult.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong><pre>${data.error}</pre></div>`;
            }
        });

        // Main Run button (for all sample tests)
        const runBtn = document.getElementById('runBtn');
        const sampleTestCases = [
            {% for test_case in problem.testcase_set.all %}
                {% if test_case.is_sample %}
                    { input: `{{ test_case.input_data|escapejs }}`, output: `{{ test_case.expected_output|escapejs }}` },
                {% endif %}
            {% endfor %}
        ];
        
        runBtn.addEventListener('click', async function() {
            const code = editor.getValue();
            const language = languageSelector.value;
            const resultsContainer = document.getElementById('sampleTestResults');
            
            resultsContainer.innerHTML = ''; // Clear previous results
            
            for (let i = 0; i < sampleTestCases.length; i++) {
                const testCase = sampleTestCases[i];
                let resultHTML = `<div class="card my-2"><div class="card-body"><h6>Test Case ${i+1}</h6>`;
                resultHTML += `<div><strong>Input:</strong><pre>${testCase.input}</pre></div>`;
                
                const data = await runCode(code, language, testCase.input);

                if (data.success) {
                    const passed = data.output.trim() === testCase.output.trim();
                    const statusClass = passed ? 'success' : 'danger';
                    resultHTML += `<div class="alert alert-${statusClass} mt-2"><strong>Your Output:</strong><pre>${data.output}</pre><strong>Expected Output:</strong><pre>${testCase.output}</pre></div>`;
                } else {
                    resultHTML += `<div class="alert alert-danger mt-2"><strong>Error:</strong><pre>${data.error}</pre></div>`;
                }
                resultHTML += `</div></div>`;
                resultsContainer.innerHTML += resultHTML;
            }
        });

        // Submit Button
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.addEventListener('click', function() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

            fetch("{% url 'submissions:submit' problem.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 
                    code: editor.getValue(), 
                    language: languageSelector.value,
                    problem_id: problemId 
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    localStorage.removeItem(getLocalStorageKey(languageSelector.value));
                    window.location.href = `/submissions/${data.submission_id}/`;
                } else {
                    alert(`Submission failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => alert(`An error occurred: ${error.message}`))
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Solution';
            });
        });
    });
</script>
{% endblock %}